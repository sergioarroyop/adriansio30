<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wake Up, Bongo</title>
  <link rel="stylesheet" href="../../assets/style.css">
  <style>
    /* Marco con la imagen del despertador */
    #timerBox { display:flex; align-items:center; justify-content:center; padding: 12px; }
    .clock { position: relative; width: min(740px, 96vw); display: inline-block; }
    .clock-img { display:block; width:100%; height:auto; }
    /* Zona de pantalla blanca (coordenadas aproximadas en porcentaje) */
    .screen {
      position: absolute;
      left: 13.5%;
      top: 37.5%;
      width: 73%;
      height: 29%;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none; /* que no intercepte el click del bot√≥n */
    }
    #timerDisplay {
      font-family: 'DS-Digital','Digital-7','Seven Segment','Orbitron','Share Tech Mono','Courier New', monospace;
      font-weight: 700;
      font-size: clamp(1.5rem, 7.2vw, 4.8rem);
      color: #0c0c0c;
      letter-spacing: 0.12rem;
      line-height: 0.96;
      text-shadow: 0 0 0 transparent;
      user-select: none;
      max-width: 100%;
      overflow: hidden;
      white-space: nowrap;
    }
    /* Hotspot sobre el bot√≥n superior centrado (sin estilo, clicable) */
    .stop-hotspot {
      position: absolute;
      top: 14%;
      left: 67%;
      width: 17%;
      height: 9%;
      background: transparent;
      border: 0;
      cursor: pointer;
      outline: none;
      -webkit-tap-highlight-color: transparent;
    }
    .stop-hotspot:focus, .stop-hotspot:focus-visible { outline: none; }
  </style>
</head>
<body>
  <div id="container">
    <div id="gameWrapper">
      <div id="retryInfo" style="position:absolute; top:12px; left:14px; color:#333; font-weight:700; background: rgba(255,255,255,0.65); padding: 6px 10px; border-radius: 8px;">
        Intentos restantes: 3 | √öltimo: --
      </div>
      <div id="timerBox" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
        <div class="clock" role="group" aria-label="Despertador">
          <img class="clock-img" src="https://i.postimg.cc/Hxsm4DYX/reloj-despertador-digital.png" alt="Despertador digital">
          <div class="screen">
            <div id="timerDisplay">16,00,00</div>
          </div>
          <button type="button" class="stop-hotspot" id="stopButton" aria-label="Parar despertador"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio de despertador -->
  <audio id="wakeAudio" src="../../sounds/wakemeup.mp3" preload="auto" loop></audio>

  <!-- Modales comunes -->
  <div id="winModal" class="hidden">
    <div class="modal-content">
      <h1>¬°Por los pelos! ‚è±Ô∏è</h1>
      <h3>Te has levantado y has llegado a tiempo</h3>
      <div class="modal-actions">
        <button class="modal-btn" id="winBackBtn">Volver</button>
        <button class="modal-btn" id="winRestartBtn">Reintentar</button>
      </div>
    </div>
  </div>

  <div id="gameOverModal" class="hidden">
    <div class="modal-content">
      <h1>¬°Te has sobado como un cabr√≥n! üòµ</h1>
      <h3>Has llegado tarde, te has sobado como un cabr√≥n</h3>
      <div class="modal-actions">
        <button class="modal-btn" id="overBackBtn">Volver</button>
        <button class="modal-btn" id="overRestartBtn">Reintentar</button>
      </div>
    </div>
  </div>

  <div id="startModal">
    <div class="modal-content">
      <h1>¬°Wake up! Bongo</h1>
      <h2>Nooooo, te has echado una siesta en el d√≠a de tu cumplea√±os, vas a llegar tarde a la fiesta. Acabas de dormirte a las 16,00,00 y el tiempo pasa volando.</h2>
      <h2>Para el despertador d√°ndole al bot√≥n justo entre las 20,00,00 y las 20,01,00 para que te de tiempo a darte una ducha antes de ir.</h2>
      <div class="modal-actions">
        <button class="modal-btn" id="startBtn">Comenzar</button>
      </div>
    </div>
  </div>

  <script src="../../assets/gameStorage.js"></script>
  <script src="../../assets/sidePanel.js"></script>
  <!-- Audio de fondo de cumplea√±os -->
  <audio id="bgBirthday" src="../../sounds/birthday.mp3" loop></audio>
  <script>
    (function(){
      const a = document.getElementById('bgBirthday');
      if (!a) return;
      a.volume = 0.6;
      a.play().catch(()=>{});
    })();
  </script>
  <script>
    // L√≥gica del juego
    let running = false;
    let rafId = null;
    let startPerf = 0;
    const BASE_START = 16.00; // segundos, arranca en 16,00,00
    const LIMIT_END = 23.00;  // segundos

    let attempts = 0;
    let lastValue = 0;
    let bestDelta = null; // distancia m√≠nima a la ventana correcta (solo interno)

    const display = document.getElementById('timerDisplay');
    const retryInfo = document.getElementById('retryInfo');
    const wakeAudio = document.getElementById('wakeAudio');

    function playWake(){
      if (!wakeAudio) return;
      try { wakeAudio.currentTime = 0; } catch(e){}
      const p = wakeAudio.play();
      if (p && p.catch) p.catch(()=>{});
    }
    function stopWake(){
      if (!wakeAudio) return;
      try { wakeAudio.pause(); } catch(e){}
      try { wakeAudio.currentTime = 0; } catch(e){}
    }

    // Sistema de reintentos
    const MAX_FAILS = 3;
    let fails = 0; // fallos acumulados en esta sesi√≥n
    let lastMarked = null; // √∫ltimo tiempo marcado real (null si no hay)

    function formatTri(n){
      // Genera SS,CC,DD (segundos, cent√©simas, decenas de mil√©simas)
      const sec = Math.floor(n);
      const centi = Math.floor(n * 100) % 100; // 0..99
      const deciMilli = Math.floor(n * 1000) % 10; // 0..9
      const two = (v)=> String(v).padStart(2,'0');
      return `${two(sec)},${two(centi)},${two(deciMilli*10)}`;
    }

    // HUD superior eliminado por petici√≥n
    function updateRetryHud(){
      if (!retryInfo) return;
      const left = Math.max(0, MAX_FAILS - fails);
      const lastTxt = (lastMarked === null) ? '--' : formatTri(lastMarked);
      retryInfo.textContent = `Intentos restantes: ${left} | √öltimo: ${lastTxt}`;
    }

    function loop(){
      if (!running) return;
      const elapsed = (performance.now() - startPerf) / 1000; // s
      let current = BASE_START + elapsed;
      if (current >= LIMIT_END){
        current = LIMIT_END;
        display.textContent = formatTri(current);
        stopAndEvaluate(current); // auto-derrota por pasarse
        return;
      }
      display.textContent = formatTri(current);
      rafId = requestAnimationFrame(loop);
    }

    function startGame(){
      attempts++;
      lastValue = BASE_START;
      running = true;
      startPerf = performance.now();
      cancelAnimationFrame(rafId);
      display.textContent = formatTri(BASE_START);
      rafId = requestAnimationFrame(loop);
      updateRetryHud();
    }

    function stopAndEvaluate(current){
      if (!running) return;
      running = false;
      cancelAnimationFrame(rafId);
      lastValue = current;
      const winStart = 20.00;
      const winEnd = 20.01; // 20,01,00
      const inWindow = current >= winStart && current <= winEnd;
      let delta = 0;
      if (!inWindow) {
        if (current < winStart) delta = (winStart - current);
        else delta = (current - winEnd);
      }
      if (bestDelta === null || delta < bestDelta) bestDelta = delta;

      if (inWindow){
        lastMarked = current;
        // Al mostrar modal de victoria, reiniciar fallos
        fails = 0;
        updateRetryHud();
        stopWake();
        const winEl = document.getElementById('winModal');
        if (winEl) {
          const msg = winEl.querySelector('.modal-content h3');
          if (msg) {
            // a√±ade el tiempo marcado al mensaje
            msg.textContent = `${msg.textContent.split(' ‚Äî ')[0]} ‚Äî Tiempo: ${formatTri(lastMarked)}`;
          }
          winEl.classList.remove('hidden');
        }
        try {
          if (window.GameStorage) {
            window.GameStorage.markGameCompleted('wake-up-bongo');
            window.GameStorage.updateGameScore('wake-up-bongo', Math.round((11 - current) * 100));
          }
        } catch(e){}
      } else {
        // fallo de intento
        lastMarked = current;
        fails += 1;
        const left = MAX_FAILS - fails;
        updateRetryHud();
        if (left <= 0){
          // fallo definitivo: reiniciar fallos al mostrar modal
          fails = 0;
          updateRetryHud();
          stopWake();
          const overEl = document.getElementById('gameOverModal');
          if (overEl) overEl.classList.remove('hidden');
        } else {
          // reiniciar autom√°ticamente desde el inicio tras un breve respiro
          setTimeout(() => { resetGame(); startGame(); }, 600);
        }
      }
    }

    function getDisplayValue(){
      const txt = display.textContent.replaceAll(',', '.');
      const parts = txt.split('.');
      if (parts.length >= 2) {
        const sec = parseInt(parts[0]||'0',10);
        const centi = parseInt(parts[1]||'0',10);
        const deciMilli = parseInt(parts[2]||'0',10); // 0..90 step 10
        return sec + centi/100 + (deciMilli/10)/1000;
      }
      const f = parseFloat(txt);
      return Number.isFinite(f) ? f : BASE_START;
    }

    // El paro se acciona desde el bot√≥n de la imagen (arriba a la derecha)
    const stopBtn = document.getElementById('stopButton');
    if (stopBtn) {
      stopBtn.addEventListener('click', () => {
        stopAndEvaluate(getDisplayValue());
      });
    }

    // Panel lateral
    let panelStats = { intentos: 0, ultimo: '16,00,00', estado: '‚è∏Ô∏è Listo' };
    let panelOptions = { velocidad: 'normal' };

    function initSidePanel(){
      if (!window.SidePanel) return;
      window.SidePanel.createSidePanel({
        gameName: 'Wake Up Bongo',
        gameId: 'wakeupbongo',
        stats: panelStats,
        options: panelOptions,
        optionsTemplate: `
          <div class="panel-section">
            <h4>‚öôÔ∏è Controles</h4>
            <div class="option-item"><span class="option-label">Parar</span><span class="option-value">Click del rat√≥n en el bot√≥n del despertador</span></div>
          </div>
        `,
        onBack: () => window.location.href = '../index.html',
        onRestart: () => { resetGame(); },
        onOptionChange: () => {}
      });
    }
    document.addEventListener('DOMContentLoaded', initSidePanel);

    // Sincronizar stats al panel
    setInterval(() => {
      if (!window.SidePanel) return;
      panelStats.intentos = attempts;
      panelStats.ultimo = formatTri(lastValue);
      panelStats.estado = running ? 'üîÑ En curso' : '‚è∏Ô∏è Listo';
      window.SidePanel.updateSidePanelStats(panelStats);
    }, 300);

    // Modales
    document.getElementById('startBtn').addEventListener('click', () => {
      document.getElementById('startModal').classList.add('hidden');
      startGame();
      playWake();
    });
    document.getElementById('winBackBtn').addEventListener('click', () => { stopWake(); window.location.href = '../index.html'; });
    document.getElementById('overBackBtn').addEventListener('click', () => { stopWake(); window.location.href = '../index.html'; });
    document.getElementById('winRestartBtn').addEventListener('click', () => { stopWake(); document.getElementById('winModal').classList.add('hidden'); resetGame(); startGame(); playWake(); });
    document.getElementById('overRestartBtn').addEventListener('click', () => { stopWake(); document.getElementById('gameOverModal').classList.add('hidden'); resetGame(); startGame(); playWake(); });

    function resetGame(){
      running = false; cancelAnimationFrame(rafId);
      lastValue = BASE_START; display.textContent = formatTri(BASE_START);
    }
  </script>
</body>
</html>
